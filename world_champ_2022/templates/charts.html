{% extends "includes/layout.html" %}
{% load static %}
{% block title %}Таблица результатов{% endblock %}

{% block navbar %} {% include "includes/navbar.html" with active_tab='results' %} {% endblock %}

{% block h1 %}<h1>Результаты</h1>{% endblock %}

{% block content %}

<script src="https://code.highcharts.com/highcharts.js" type="text/javascript"></script>
<script src="https://code.highcharts.com/modules/exporting.js" type="text/javascript"></script>
<script src="https://code.highcharts.com/modules/data.js" type="text/javascript"></script>
<script src="https://code.highcharts.com/modules/drilldown.js" type="text/javascript"></script>

<script>
	$(function () {
		$('#container').highcharts({
			title: {
				text: 'График состязания',
				x: -20 //center
			},
			xAxis: {
				categories: [
				'',
				{% for msg in match_score_guesses %}
					{% if msg.match.penalty_score_1 != None %}
						{% if msg.match.extra_score_1 != None %}
					'{{msg.match.command_1.name}} - {{msg.match.command_2.name}} ({{msg.match.score_1}} : {{msg.match.score_2}}, ДВ {{msg.match.extra_score_1}} : {{msg.match.extra_score_2}}, пен. {{msg.match.penalty_score_1}} : {{msg.match.penalty_score_2}})',
						{% else %}
					'{{msg.match.command_1.name}} - {{msg.match.command_2.name}} ({{msg.match.score_1}} : {{msg.match.score_2}}, пен. {{msg.match.penalty_score_1}} : {{msg.match.penalty_score_2}})',
						{% endif %}
					{% else %}
						{% if msg.match.extra_score_1 != None %}
					'{{msg.match.command_1.name}} - {{msg.match.command_2.name}} ({{msg.match.score_1}} : {{msg.match.score_2}}, ДВ {{msg.match.extra_score_1}} : {{msg.match.extra_score_2}})',
						{% else %}
					'{{msg.match.command_1.name}} - {{msg.match.command_2.name}} ({{msg.match.score_1}} : {{msg.match.score_2}})',
						{% endif %}
					{% endif %}
				{% endfor %}
					]
				
			},
			yAxis: {
				title: {
					text: 'Очки'
				},
				tickInterval: 1,
				plotLines: [{
					value: 0,
					width: 1,
					color: '#808080'
				}]
			},
			tooltip: {
				useHTML: true,
				formatter: function() {
					if (this.point.prediction == 'firstPoint')
						return '<b>' + this.series.name + '</b>'
					return '<span style="font-size: 15px">' + this.series.name + '</span>' + 
					'<br><b>Матч: </b>' + this.point.match + 
					'<br><b>Счёт: </b>' + this.point.match_score +
					'<br><b>Прогноз: </b>' + this.point.prediction +
					'<br><b>Заработанные очки: </b>' + this.point.earned_points
					;
				}
			},
			legend: {
				useHTML: true,
				layout: 'vertical',
				align: 'right',
				verticalAlign: 'middle',
				borderWidth: 0
			},
			series: [
			{% for chart_element in chart_data %}
			{
				name: '{{chart_element.user.first_name}} {{chart_element.user.last_name}} {% if chart_element.user.player.money %}<img src="{% static "coins.png" %}" class="coin_icon"/>{% endif %}',
				data: [
				{y : 0, prediction : 'firstPoint'},
				{% for data in chart_element.data %}
				{ y : {{data.score}}, prediction : '{{data.prediction}}', match:  '{{data.match}}', match_score: '{{data.match_score}}', earned_points: '{{data.earned_points}}'},
				{% endfor %}
				]
			},
			{% endfor %}
			],
			responsive: {
				rules: [{
					condition: {
						maxWidth: 500
					},
					chartOptions: {
						legend: {
							align: 'center',
							verticalAlign: 'bottom',
							layout: 'horizontal'
						}
					}
				}]
			}
		});
	});
</script>

<br/>
<br/>
<div id="container" style="height: 600px; margin: 0 auto"></div>
<br/>
<br/>


<hr class="my-4">
<br/>
<div style="max-height: 800px; overflow:auto;">
<table class="pure-table pure-table-bordered center_table">
	<caption>Таблица результатов</caption>
	<thead>
		<tr>
			<th></th>
			{% for user in users %}
			<th colspan="3">{{user.first_name}}<br/>{{user.last_name}}</th>
			{% endfor %}
		</tr>
	</thead>

	<tbody>
		{% for msg in match_score_guesses %}
		<tr>
			<td rowspan="3" style="white-space: nowrap;">
			{% if msg.match.command_1.flag %}
			<img src="{{msg.match.command_1.flag.url}}">
			{% endif %}
			{{msg.match.command_1.name}} - {{msg.match.command_2.name}} 
			{% if msg.match.command_2.flag %}
				<img src="{{msg.match.command_2.flag.url}}">
			{% endif %}	<br/>

			{% load tz %}
			{% localtime on %}
			{{msg.match.time|date:"o-m-d H:i:s"}} <br/>
			{% endlocaltime %}

			{% if msg.match.score_1 != None %}
				{% if msg.match.penalty_score_1 != None %}
					{% if msg.match.extra_score_1 != None %}
						{{msg.match.score_1}} : {{msg.match.score_2}}, ДВ {{msg.match.extra_score_1}} : {{msg.match.extra_score_2}}, пен. {{msg.match.penalty_score_1}} : {{msg.match.penalty_score_2}}
					{% else %}
						{{msg.match.score_1}} : {{msg.match.score_2}}, пен. {{msg.match.penalty_score_1}} : {{msg.match.penalty_score_2}}
					{% endif %}
				{% else %}
					{% if msg.match.extra_score_1 != None %}
						{{msg.match.score_1}} : {{msg.match.score_2}}, ДВ {{msg.match.extra_score_1}} : {{msg.match.extra_score_2}}
					{% else %}
						{{msg.match.score_1}} : {{msg.match.score_2}}
					{% endif %}
				{% endif %}
			{% else %}
			- : -
			{% endif %}
			</td>
			{% for user_guess in msg.user_guesses %}
				{% if msg.enabled %}
				<td colspan="3">{{user_guess.guess.guess_score_1}} - {{user_guess.guess.guess_score_2}}</td>
				{% else %}
					{% if user_guess.guess.guess_score_1 != None %}
						<td colspan="3">●</td>
					{% else %}
						<td colspan="3"></td>
					{% endif %}
				{% endif %}
			{% endfor %}
		</tr>
			{% for user_guess in msg.user_guesses %}
				{% if msg.enabled %}
					{% if msg.match.score_1 != None %}
					<td>{{user_guess.victory_point}}</td>
					<td>{{user_guess.difference_point}}</td>
					<td>{{user_guess.exact_score_point}}</td>
					{% else %}
					<td></td>
					<td></td>
					<td></td>
					{% endif %}
				{% else %}
					<td></td>
					<td></td>
					<td></td>
				{% endif %}
			{% endfor %}
		<tr>
			{% for user_guess in msg.user_guesses %}
				{% if msg.enabled %}
					{% if msg.match.score_1 != None %}
					<td colspan="3">{{user_guess.total_point}}</td>
					{% else %}
					<td colspan="3"></td>
					{% endif %}
				{% else %}
					<td colspan="3"></td>
				{% endif %}
			{% endfor %}
		</tr>
		{% endfor %}
	</tbody>
</table>
</div>

<br/>
{% endblock %}
